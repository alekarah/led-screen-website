<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
#map { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script src="https://api-maps.yandex.ru/2.1/?apikey=7dfc2fa2-8cbd-465a-8101-0a9ce00d82c5&lang=ru_RU"></script>
<script>
// Получаем данные точек из родительской страницы через postMessage
window.addEventListener('message', function(e) {
  if (!e.data || e.data.type !== 'map-points') return;
  initMap(e.data.points || []);
});

function initMap(points) {
  ymaps.ready(function() {
    var map = new ymaps.Map('map', {
      center: [59.938784, 30.315868],
      zoom: 9,
      controls: ['zoomControl']
    });

    if (points.length === 0) return;

    var clusterer = new ymaps.Clusterer({
      preset: 'islands#invertedLightBlueClusterIcons',
      clusterDisableClickZoom: false,
      clusterBalloonContentLayout: 'cluster#balloonCarousel'
    });

    // Соответствие типа точки → файл иконки
    var iconMap = {
      supersign:     '/static/images/map-icons/supersign.svg',
      billboard:     '/static/images/map-icons/billboard.svg',
      lightposter:   '/static/images/map-icons/lightposter.svg',
      cityboard:     '/static/images/map-icons/cityboard.svg',
      media_facade:  '/static/images/map-icons/media_facade.svg',
      gas_station:   '/static/images/map-icons/gas_station.svg',
      indoor_screen: '/static/images/map-icons/indoor_screen.svg'
    };

    // Русские названия типов для балуна
    var iconLabels = {
      supersign:     'Суперсайт',
      billboard:     'Билборд',
      lightposter:   'Лайтпостер',
      cityboard:     'Ситиборд',
      media_facade:  'Медиафасад',
      gas_station:   'АЗС',
      indoor_screen: 'Интерьерный экран'
    };

    var placemarks = [];
    points.forEach(function(p) {
      var typeLabel = iconLabels[p.icon_type] || 'Билборд';
      var body = '<div style="margin-bottom:6px;color:#888;font-size:12px;font-style:italic;">Тип: ' + typeLabel + '</div>';
      if (p.description) {
        body += '<div style="margin-bottom:8px;color:#555;font-size:13px;">' + p.description + '</div>';
      }
      if (p.panorama_url) {
        body += '<a href="' + p.panorama_url + '" target="_blank" rel="noopener noreferrer"' +
          ' style="display:inline-block;padding:6px 14px;background:#1a73e8;color:#fff;' +
          'border-radius:6px;font-size:13px;text-decoration:none;font-family:sans-serif;">' +
          '&#9654; Панорама</a>';
      }

      var iconHref = iconMap[p.icon_type] || iconMap['billboard'];

      placemarks.push(new ymaps.Placemark(
        [p.latitude, p.longitude],
        {
          balloonContentHeader: '<strong>' + p.title + '</strong>',
          balloonContentBody: body,
          hintContent: p.title
        },
        {
          iconLayout: 'default#image',
          iconImageHref: iconHref,
          iconImageSize: [40, 40],
          iconImageOffset: [-20, -20]
        }
      ));
    });

    clusterer.add(placemarks);
    map.geoObjects.add(clusterer);

    if (placemarks.length > 1) {
      map.setBounds(clusterer.getBounds(), { checkZoomRange: true, zoomMargin: 40 });
    } else if (placemarks.length === 1) {
      map.setCenter([points[0].latitude, points[0].longitude], 14);
    }
  });
}
</script>
</body>
</html>
