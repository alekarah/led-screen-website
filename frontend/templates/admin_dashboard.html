{{define "admin-dashboard-content"}}
<div class="form-section">
    <h2>Общая статистика</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Проекты</div>
            <div class="stat-value">{{.stats.ProjectsCount}}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Изображения</div>
            <div class="stat-value">{{.stats.ImagesCount}}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Заявки</div>
            <div class="stat-value">{{.stats.ContactsCount}}</div>
        </div>
    </div>
</div>

<div class="form-section">
  <h2>Заявки за 7 дней ({{.newContacts7}})</h2>
  <div class="chart-box">
    <canvas id="contactsChart"></canvas>
  </div>
</div>

<!-- 1) ЛОКАЛЬНАЯ копия Chart.js (основной источник) + тихий фоллбек на CDN -->
<script src="/static/js/vendor/chart.min.js"
        defer
        onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/chart.js';s.defer=true;s.onerror=function(){window.__chartFailed=true};document.body.appendChild(s)})()">
</script>

<!-- 2) Инициализация графика (без блокировок и с таймаутами) -->
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // ждём появления window.Chart до 1200 мс
  const waitChart = () => new Promise(resolve => {
    const start = Date.now();
    const t = setInterval(() => {
      if (window.Chart) { clearInterval(t); resolve(true); }
      if (Date.now() - start > 1600 || window.__chartFailed) { clearInterval(t); resolve(false); }
    }, 40);
  });
  const hasChart = await waitChart();

  // тянем данные с таймаутом 2с, чтобы вкладка не «висела»
  let data = [];
  try {
    const ac = new AbortController();
    const to = setTimeout(() => ac.abort(), 2000);
    const res = await fetch(`/api/admin/contacts-7d?_=${Date.now()}`, { signal: ac.signal });
    clearTimeout(to);
    data = await res.json();
  } catch (e) {
    console.warn('contacts-7d fetch:', e);
    if (window.showAdminMessage) showAdminMessage('Не удалось загрузить данные для графика', 'error');
  }

  // если Chart.js не загрузился — показываем заметку вместо графика
  if (!hasChart) {
    const canvas = document.getElementById('contactsChart');
    if (canvas) {
      const note = document.createElement('div');
      note.style.color = '#6b7280';
      note.style.padding = '12px 0';
      note.textContent = 'График недоступен (Chart.js не загрузился).';
      canvas.replaceWith(note);
    }
    return;
  }

  // строим график
  try {
    const labels = (data || []).map(d => (d.day || '').slice(5));
    const values = (data || []).map(d => d.count || 0);
    const ctx = document.getElementById('contactsChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Заявки', data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
  } catch (e) {
    console.error('Chart render error:', e);
    if (window.showAdminMessage) showAdminMessage('Ошибка отрисовки графика', 'error');
  }
});
</script>

<div class="form-section">
  <h2>Перезвоны</h2>
  <div class="stats-grid">
    <a class="stat-card" href="/admin/contacts?reminder=today" style="text-decoration:none;color:inherit;">
      <div class="stat-label">Сегодня</div>
      <div class="stat-value">{{.reminders.today}}</div>
    </a>
    <a class="stat-card" href="/admin/contacts?reminder=overdue" style="text-decoration:none;color:inherit;">
      <div class="stat-label">Просрочено</div>
      <div class="stat-value">{{.reminders.overdue}}</div>
    </a>
  </div>


  {{if .reminders.upcoming}}
  <div class="dashboard-reminders" style="margin-top:12px">
    <h3 style="margin:0 0 8px 0;font-size:16px;">Ближайшие перезвоны (10)</h3>
    <table class="contacts-table">
      <thead>
        <tr>
          <th style="width:36px">#</th>
          <th style="width:28%">Имя</th>
          <th style="width:28%">Телефон</th>
          <th>Когда</th>
        </tr>
      </thead>
      <tbody>
        {{range $i, $c := .reminders.upcoming}}
        <tr>
          <td>{{add $i 1}}</td>
          <td>{{$c.Name}}</td>
          <td>
            {{if $c.Phone}}
              <a href="tel:{{$c.Phone}}">{{$c.Phone}}</a>
            {{else}} — {{end}}
          </td>
          <td>{{if $c.RemindAt}}{{fmtTime $c.RemindAt}}{{else}}—{{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
</div>


<div class="form-section">
    <h2>Система</h2>
    <div class="sys-grid">
        <div class="sys-item">
        <div class="sys-label">Подключение к БД</div>
        {{if .sys.dbOK}}
            <span class="badge badge-ok">OK</span>
        {{else}}
            <span class="badge badge-error">Ошибка</span>
        {{end}}
        </div>

        <div class="sys-item">
        <div class="sys-label">Окружение</div>
        <div class="sys-value">{{if .sys.env}}{{.sys.env}}{{else}}—{{end}}</div>
        </div>

        <div class="sys-item">
        <div class="sys-label">Версия</div>
        <div class="sys-value">{{if .sys.version}}{{.sys.version}}{{else}}—{{end}}</div>
        </div>

        <div class="sys-item">
        <div class="sys-label">Время сервера</div>
        <div class="sys-value">{{fmtTime .sys.serverNow}}</div>
        </div>
    </div>
</div>

{{end}}
