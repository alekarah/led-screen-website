# Миграция на систему Thumbnails

## Что было сделано

Добавлена система автоматической генерации thumbnails для оптимизации загрузки изображений:

### Размеры thumbnails:
- **Small** (400×300px, ~50KB) - для карточек проектов, главной страницы, админки
- **Medium** (1200×900px, ~180KB) - для модального окна галереи
- **Large** (2000×1500px, ~500KB) - для кнопки "Открыть изображение"
- **Original** - оригинал сохраняется для качества и регенерации

### Результат оптимизации:
- Карточки проектов: **в 140 раз быстрее** (7MB → 50KB)
- Галерея: **в 39 раз быстрее** (7MB → 180KB)
- Просмотр: **в 14 раз быстрее** (7MB → 500KB)

## Шаги миграции

### 1. Обновить зависимости

```bash
cd backend
go mod tidy
```

### 2. Запустить миграцию базы данных

Запустите приложение один раз - GORM автоматически добавит новые колонки в таблицу `images`:
- `thumbnail_small_path`
- `thumbnail_medium_path`
- `thumbnail_large_path`

```bash
cd backend
go run main.go
```

После запуска остановите приложение (Ctrl+C).

### 3. Регенерировать thumbnails для существующих изображений

**ВАЖНО**: Запустите эту утилиту для обработки всех существующих изображений:

```bash
# Из корня проекта:
cd backend/cmd/regenerate-thumbnails
go run main.go

# Или в одну команду:
cd backend && cd cmd/regenerate-thumbnails && go run main.go
```

Утилита:
- Обработает все изображения из базы данных
- Создаст 3 thumbnail для каждого изображения
- Применит текущие настройки кроппинга
- Сконвертирует .jfif в .jpg автоматически
- Покажет прогресс и статистику

Пример вывода:
```
=== Утилита регенерации thumbnails ===

Найдено 15 изображений для обработки

[1/15] Обработка изображения ID=1: project_10_1753455135_0.png
  ✅ Успешно: созданы thumbnails (small, medium, large)
[2/15] Обработка изображения ID=2: project_11_1753455505_0.png
  ✅ Успешно: созданы thumbnails (small, medium, large)
...

=== Итоги ===
Всего изображений: 15
✅ Успешно обработано: 15
❌ Ошибок: 0
⚠️  Пропущено: 0
```

### 4. Запустить приложение

```bash
cd backend
go run main.go
```

Откройте сайт и проверьте:
- Главную страницу
- Страницу проектов
- Модальное окно галереи
- Кнопку "Открыть изображение"
- Админку

## Автоматическая работа системы

После миграции thumbnails будут **автоматически**:

### При загрузке нового изображения
1. Сохраняется оригинал
2. Создаются 3 thumbnail (small, medium, large)
3. Пути сохраняются в БД
4. .jfif автоматически конвертируется в .jpg

### При изменении кроппинга
1. Пользователь настраивает crop в редакторе
2. Нажимает "Сохранить"
3. Thumbnails **регенерируются** с новыми параметрами
4. Качество сохраняется (кроп применяется к оригиналу)

### При удалении изображения
Удаляются:
- Оригинал
- Все 3 thumbnail

## Production deployment

### На локальной машине:
1. Выполните все шаги миграции выше
2. Протестируйте локально
3. Закоммитьте изменения

### На production сервере:
1. Сделайте backup базы данных и папки uploads
2. Загрузите новый код
3. Запустите `go run main.go` (миграция БД)
4. Остановите
5. Запустите `cd cmd/regenerate-thumbnails && go run main.go`
6. Запустите основное приложение
7. Проверьте работу сайта

## Устранение проблем

### Thumbnails не создаются
- Проверьте права на запись в `/frontend/static/uploads/`
- Проверьте размер файла (должен быть < 10MB)
- Посмотрите логи: `[DEBUG]` и `[ERROR]`

### Старые изображения показывают оригиналы
- Запустите утилиту регенерации повторно
- Проверьте что пути сохранились в БД: `SELECT id, thumbnail_small_path FROM images;`

### .jfif не конвертируются
- Система автоматически конвертирует при создании thumbnails
- Оригинал .jfif остается, thumbnails создаются как .jpg

## Технические детали

### Файлы изменены:
- `backend/internal/models/models.go` - добавлены поля для thumbnails
- `backend/internal/handlers/image_processor.go` - NEW: обработка изображений
- `backend/internal/handlers/admin_images.go` - генерация при загрузке/кроппинге
- `backend/main.go` - helper функция `getThumbnail`
- `frontend/templates/*.html` - использование thumbnails
- `frontend/static/js/project-modal.js` - thumbnails в галерее
- `backend/cmd/regenerate-thumbnails/main.go` - NEW: утилита миграции

### Библиотеки:
- `github.com/disintegration/imaging` - обработка изображений
- Lanczos resampling для высокого качества
- JPEG Quality 85% - баланс качества/размера
- Progressive encoding - для плавной загрузки

## Вопросы и поддержка

Если возникли проблемы, проверьте:
1. Логи приложения
2. Права на файлы в `uploads/`
3. Запустили ли утилиту регенерации

Все thumbnails имеют fallback к оригиналу, поэтому сайт продолжит работать даже если что-то пошло не так.
